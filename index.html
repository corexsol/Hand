<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>Hand Tap â†’ Success (Video)</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#030418">
  <meta name="theme-color" content="#030418" media="(prefers-color-scheme: dark)">
  <link rel="icon" href="icons/icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <style>
    :root { --bg:#030418; --t:720ms; --e:cubic-bezier(.2,.8,.2,1); --vh:1vh; color-scheme: dark; }
    *{ -webkit-user-select:none; user-select:none; -webkit-touch-callout:none; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; margin:0; background:var(--bg); overflow:hidden; overscroll-behavior:none; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; }
    html,body,.stage,video,#hit,.success{ touch-action:none; }
    :fullscreen, ::backdrop{ background:#030418; }

    .stage, .success, #hit{ position:fixed; inset:0; height:calc(var(--vh) * 100) !important; }
    video{ width:100vw; height:calc(var(--vh) * 100) !important; }

    /* Scene 1 */
    .stage{ background:var(--bg); }
    .stage video{ position:absolute; inset:0; }
    .bgS1{
      object-fit:cover; transform:scale(1.15);
      filter:blur(12px) brightness(.7) saturate(1.08);
      transition:transform var(--t) var(--e), opacity var(--t) var(--e);
      z-index:0; pointer-events:none;
    }
    .fgS1{
      object-fit:contain; background:transparent; transform:scale(1);
      transition:transform 240ms var(--e), opacity var(--t) var(--e), filter var(--t) var(--e);
      z-index:1; pointer-events:none;
    }
    .pressed .fgS1{ transform:scale(1.03); filter:brightness(.98); }
    .go .fgS1{ transform:scale(1.06); filter:blur(2px) brightness(.9); transition:transform 520ms var(--e), filter 520ms var(--e); }
    .returning .fgS1{ transform:scale(1); filter:none; }

    #hit{ z-index:2; background:transparent; }

    /* Scene 2 */
    .success{
      z-index:4;
      background:rgba(3,4,24,0);
      backdrop-filter:blur(0px) saturate(110%); -webkit-backdrop-filter:blur(0px) saturate(110%);
      opacity:0; visibility:hidden; transform:scale(.985);
      transition:
        opacity var(--t) var(--e),
        transform var(--t) var(--e),
        visibility 0s linear var(--t),
        backdrop-filter 520ms var(--e),
        -webkit-backdrop-filter 520ms var(--e),
        background 520ms var(--e);
    }
    .go .success{
      opacity:1; visibility:visible; transform:scale(1);
      backdrop-filter:blur(12px) saturate(125%); -webkit-backdrop-filter:blur(12px) saturate(125%);
      background:rgba(3,4,24,.55);
    }

    .bgS2{
      position:absolute; inset:0; object-fit:cover; pointer-events:none;
      transform:scale(1.08);
      filter:blur(16px) brightness(.72) saturate(1.1);
      opacity:0;
      transition: opacity 680ms var(--e), transform 900ms var(--e), filter 900ms var(--e);
      z-index:0;
    }
    .go .bgS2{ opacity:1; transform:scale(1.15); filter:blur(12px) brightness(.72) saturate(1.1); }
    .success.out .bgS2{
      opacity:0; transform:scale(1.12); filter:blur(16px) brightness(.7) saturate(1.05);
      transition: opacity 420ms var(--e), transform 420ms var(--e), filter 420ms var(--e);
    }

    .fgS2{
      position:absolute; inset:0; object-fit:contain; pointer-events:none;
      opacity:0; transform:translateY(22px) scale(.972); filter:blur(14px);
      z-index:1; will-change:opacity,transform,filter;
    }
    .go .fgS2{ animation: svIn 820ms var(--e) 80ms both; }
    .success.out .fgS2{ animation: svOut 420ms var(--e) forwards; }

    @keyframes svIn{
      0%   { opacity:0; transform:translateY(22px) scale(.972); filter:blur(14px); }
      60%  { opacity:1; transform:translateY(-3px) scale(1.012); filter:blur(0); }
      100% { opacity:1; transform:translateY(0)    scale(1.000); filter:blur(0); }
    }
    @keyframes svOut{
      0%   { opacity:1; transform:translateY(0) scale(1); filter:blur(0); }
      100% { opacity:0; transform:translateY(10px) scale(.985); filter:blur(10px); }
    }
  </style>
</head>
<body>
  <!-- Scene 1 -->
  <div class="stage">
    <!-- BG will be driven by captureStream from fg -->
    <video class="bgS1" id="bgS1" muted playsinline preload="metadata"></video>
    <video class="fgS1" id="fgS1" src="assets/hand-loop.mp4" muted playsinline autoplay preload="auto"></video>
  </div>

  <!-- Tap area -->
  <div id="hit" aria-hidden="true"></div>

  <!-- Scene 2 -->
  <section class="success" id="success">
    <!-- BG will be driven by captureStream from fg -->
    <video class="bgS2" id="bgS2" muted playsinline preload="metadata"></video>
    <video class="fgS2" id="fgS2" src="assets/hand-loop2.mp4" muted playsinline preload="auto"></video>
  </section>

  <script>
  // Prevent context menu
  addEventListener('contextmenu', e => e.preventDefault(), {capture:true});

  // Visual viewport height fix
  (function(){
    function setVh(){
      const h = (window.visualViewport ? visualViewport.height : innerHeight);
      document.documentElement.style.setProperty('--vh', (h * 0.01) + 'px');
    }
    setVh();
    addEventListener('resize', setVh, {passive:true});
    addEventListener('orientationchange', () => setTimeout(setVh, 250), {passive:true});
    ['fullscreenchange','webkitfullscreenchange','msfullscreenchange']
      .forEach(ev => document.addEventListener(ev, () => setTimeout(setVh, 50), {passive:true}));
  })();

  const hit = document.getElementById('hit');
  const success = document.getElementById('success');

  // Scene 1 elements
  const fgS1 = document.getElementById('fgS1');
  const bgS1 = document.getElementById('bgS1');

  // Scene 2 elements
  const fgS2 = document.getElementById('fgS2');
  const bgS2 = document.getElementById('bgS2');

  // Single-decode: route BG videos from FG via captureStream (fallback to same src)
  function linkBgToFg(bg, fg){
    const doLink = () => {
      if (typeof fg.captureStream === 'function') {
        try { bg.srcObject = fg.captureStream(); return; } catch(_) {}
      }
      // Fallback (rare): use same src; SW range handler will still prevent re-download spikes
      if (!bg.src) bg.src = fg.currentSrc || fg.src;
    };
    if (fg.readyState >= 1) doLink();
    else fg.addEventListener('loadedmetadata', doLink, { once:true });
  }
  linkBgToFg(bgS1, fgS1);
  linkBgToFg(bgS2, fgS2);

  // Autoplay nudge ONLY for scene 1
  const nudge = () => { fgS1.play().catch(()=>{}); };
  addEventListener('touchstart', nudge, { once:true, passive:false });
  addEventListener('pointerdown', nudge, { once:true, passive:false });

  // Press visual
  function pressOn(){ if (!document.body.classList.contains('go')) document.body.classList.add('pressed'); }
  function pressOff(){ document.body.classList.remove('pressed'); }

  // Success flow
  const BACK_LOCK_MS = 4000;
  let useTouch = false, touches = 0, backUnlock = 0;

  // Ensure Scene 2 starts from 0 and plays once (remove loop if you want freeze-on-end)
  function resetS2(){
    try { fgS2.pause(); } catch{}
    try { fgS2.currentTime = 0; } catch{}
    // bgS2 follows via srcObject
  }
  function startS2(){
    requestAnimationFrame(() => { fgS2.play().catch(()=>{}); });
  }
  function fireSuccess(){
    resetS2();
    document.body.classList.add('go');
    pressOff();
    backUnlock = performance.now() + BACK_LOCK_MS;
    startS2();
  }

  // TOUCH path
  hit.addEventListener('touchstart', (e) => {
    useTouch = true;
    e.preventDefault();
    touches = e.touches.length;
    if (touches > 0) pressOn();
  }, {passive:false});
  function onTouchEnd(e){
    e.preventDefault();
    touches = e.touches.length;
    if (touches === 0){
      if (!document.body.classList.contains('go')) fireSuccess();
      else pressOff();
    }
  }
  hit.addEventListener('touchend', onTouchEnd, {passive:false});
  hit.addEventListener('touchcancel', onTouchEnd, {passive:false});

  // POINTER fallback
  const pset = new Set();
  hit.addEventListener('pointerdown', (e) => {
    if (useTouch) return;
    e.preventDefault();
    pset.add(e.pointerId);
    try { hit.setPointerCapture(e.pointerId); } catch(_){}
    pressOn();
  }, {passive:false});
  function onPointerUp(e){
    if (useTouch) return;
    pset.delete(e.pointerId);
    if (pset.size === 0){
      if (!document.body.classList.contains('go')) fireSuccess();
      else pressOff();
    }
  }
  hit.addEventListener('pointerup', onPointerUp, {passive:true});
  hit.addEventListener('pointercancel', onPointerUp, {passive:true});

  // Back via double-tap/click (after lock window)
  let lastTap = 0;
  function beginBack(){
    const t = performance.now();
    if (t < backUnlock) return;
    success.classList.add('out');
    try { fgS2.pause(); } catch{}
  }
  success.addEventListener('dblclick', beginBack);
  success.addEventListener('touchend', () => {
    const t = performance.now();
    if (t < backUnlock) return;
    if (t - lastTap < 320) beginBack();
    lastTap = t;
  }, {passive:true});

  // After overlay fade-out, return to scene 1
  success.addEventListener('transitionend', (e) => {
    if (e.propertyName === 'opacity' && success.classList.contains('out')) {
      success.classList.remove('out');
      document.body.classList.remove('go');
      document.body.classList.add('returning');
      setTimeout(() => document.body.classList.remove('returning'), 720);
    }
  });

  // Fullscreen + portrait lock once
  addEventListener('pointerdown', async () => {
    const el = document.documentElement;
    (el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen)?.call(el);
    try { await screen.orientation.lock('portrait'); } catch(_){}
  }, { once:true, passive:true });

  // Register SW
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  }
  </script>
</body>
</html>
